---
title: "data preprocessing"
author: "Yingzhou Liu"
date: "1/17/2021"
output: pdf_document
---

```{r}
# require libraries
library(haven)
library(tidyverse)
```


```{r}
# read data patient_5groups.sas7bdat
orDf <- read_sas("patient_5groups.sas7bdat")
```

```{r}
# save it as csv
write.csv(orDf, "patient_5groups.csv")
```


```{r}
# number of trials
length(unique(orDf$protocol))
```

```{r}
# 4 groups(1: NSCLC Stage III 2: NSCLC Stage IV 3: SCLC limited 4: SCLC extensive)
orDf %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup))  %>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```

```{r}
# 4 groups(1: NSCLC Stage III 2: NSCLC Stage IV 3: SCLC limited 4: SCLC extensive)
orDf %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```

```{r}
# bmi missing
trialsBmiMissing <- orDf %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% select(protocol, subgroup, histology, stage_initial, sclc_stage, survdays, eligible, exclude, age, bmi, wgt_losspct, gender, ps) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>% filter(is.na(bmi)) %>% group_by(protocol) %>% summarise(freq = n())

trialsBmiMissingInDf <- orDf %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% select(protocol, subgroup, histology, stage_initial, sclc_stage, survdays, eligible, exclude, age, bmi, wgt_losspct, gender, ps) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>% filter(protocol %in% trialsBmiMissing$protocol) %>% group_by(protocol) %>% summarise(freq = n())

completeTrialMissingBmi <- trialsBmiMissing$protocol[which(trialsBmiMissingInDf$freq - trialsBmiMissing$freq == 0)]
```

```{r}
# WL missing
trialsWlMissing <- orDf %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% select(protocol, subgroup, histology, stage_initial, sclc_stage, survdays, eligible, exclude, age, bmi, wgt_losspct, gender, ps) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>% filter(is.na(wgt_losspct)) %>% group_by(protocol) %>% summarise(freq = n())

trialsWlMissingInDf <- orDf %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% select(protocol, subgroup, histology, stage_initial, sclc_stage, survdays, eligible, exclude, age, bmi, wgt_losspct, gender, ps) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>% filter(protocol %in% trialsWlMissing$protocol) %>% group_by(protocol) %>% summarise(freq = n())

completeTrialMissingWl <- trialsWlMissing$protocol[which(trialsWlMissingInDf$freq - trialsWlMissing$freq == 0)]
```

```{r}
# Overlap between bmi missing trials and wl missing trials 
# 13 -> bmi
# 30 -> wl
# 41 -> bmi / wl
# 2 -> bmi + wl
orDf %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% select(protocol, subgroup, histology, stage_initial, sclc_stage, survdays, eligible, exclude, age, bmi, wgt_losspct, gender, ps) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453'))) %>% filter(protocol %in% unique(c(completeTrialMissingWl, completeTrialMissingBmi))) %>% select("protocol", "wgt_losspct", "bmi", "subgroup") %>% group_by(protocol) %>% summarise(BMI_Missing = ifelse(sum(!is.na(bmi)) == 0, "Yes", "No"), WL_Missing = ifelse(sum(!is.na(wgt_losspct)) == 0, "Yes", "No"), freq = n()) %>% mutate(cum = cumsum(freq*!duplicated(protocol)))
```

```{r}
orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))%>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```

```{r}
orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))%>% filter(eligible!=1|is.na(eligible)) %>% filter(exclude!=2|is.na(exclude)) %>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```


```{r}
orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))%>% filter(eligible!=1|is.na(eligible)) %>% filter(exclude!=2|is.na(exclude)) %>% filter(ps %in% c(0,1,2)) %>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```

```{r}
orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))%>% filter(eligible!=1|is.na(eligible)) %>% filter(exclude!=2|is.na(exclude)) %>% filter(ps %in% c(0,1,2)) %>% filter(!is.na(survdays)) %>% filter(!is.na(age)) %>% filter(!is.na(gender)) %>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```

```{r}
orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))%>% filter(eligible!=1|is.na(eligible)) %>% filter(exclude!=2|is.na(exclude)) %>% filter(ps %in% c(0,1,2)) %>% filter(!is.na(survdays)) %>% filter(!is.na(age)) %>% filter(!is.na(gender)) %>% filter(bmi<=50)  %>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```


```{r}
orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))%>% filter(eligible!=1|is.na(eligible)) %>% filter(exclude!=2|is.na(exclude)) %>% filter(ps %in% c(0,1,2)) %>% filter(!is.na(survdays)) %>% filter(!is.na(age)) %>% filter(!is.na(gender)) %>% filter(bmi<=50)  %>% mutate(histology = ifelse(is.na(histology) & (subgroup %in% c(1,2)) , 99, histology)) %>% mutate(histology = ifelse(is.na(histology) & (subgroup %in% c(3,4)) , 1, histology)) %>% filter(!((histology == 1) & (subgroup %in% c(1,2)))) %>% filter(!((histology %in% c(3,4,5,6,7,8,99)) & (subgroup %in% c(3,4)))) %>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```


```{r}
orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))  %>% filter(!is.na(survdays)) %>% filter(bmi<=50) %>% filter(!is.na(age)) %>% filter(!is.na(gender)) %>% filter(ps %in% c(0,1,2)) %>% mutate(race = ifelse(is.na(race),99, race), stage_initial = ifelse(is.na(stage_initial) & subgroup == 1, 3.3, stage_initial)) %>% mutate(stage_initial = ifelse(is.na(stage_initial) & subgroup == 2, 4.1, stage_initial)) %>% mutate(stage_initial = ifelse(!is.na(stage_initial) & subgroup == 3, 1, stage_initial))  %>% mutate(stage_initial = ifelse(!is.na(stage_initial) & subgroup == 4, 2, stage_initial)) %>% mutate(sclc_stage = ifelse(!is.na(sclc_stage) & subgroup == 1, NA, sclc_stage)) %>% mutate(sclc_stage = ifelse(!is.na(sclc_stage) & subgroup == 2, NA, sclc_stage)) %>% mutate(sclc_stage = ifelse(is.na(sclc_stage) & subgroup == 3, 1, sclc_stage))  %>% mutate(sclc_stage = ifelse(is.na(sclc_stage) & subgroup == 4, 2, sclc_stage)) %>% mutate(histology = ifelse(is.na(histology) & (subgroup %in% c(1,2)) , 99, histology)) %>% mutate(histology = ifelse(is.na(histology) & (subgroup %in% c(3,4)) , 1, histology)) %>% filter(!((histology == 1) & (subgroup %in% c(1,2)))) %>% filter(!((histology %in% c(3,4,5,6,7,8,99)) & (subgroup %in% c(3,4)))) %>% filter(eligible!=1|is.na(eligible)) %>% filter(exclude!=2|is.na(exclude)) %>% group_by(protocol) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```
```{r}
orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))  %>% filter(!is.na(survdays)) %>% filter(bmi<=50) %>% filter(!is.na(age)) %>% filter(!is.na(gender)) %>% filter(ps %in% c(0,1,2)) %>% mutate(race = ifelse(is.na(race),99, race), stage_initial = ifelse(is.na(stage_initial) & subgroup == 1, 3.3, stage_initial)) %>% mutate(stage_initial = ifelse(is.na(stage_initial) & subgroup == 2, 4.1, stage_initial)) %>% mutate(stage_initial = ifelse(!is.na(stage_initial) & subgroup == 3, 1, stage_initial))  %>% mutate(stage_initial = ifelse(!is.na(stage_initial) & subgroup == 4, 2, stage_initial)) %>% mutate(sclc_stage = ifelse(!is.na(sclc_stage) & subgroup == 1, NA, sclc_stage)) %>% mutate(sclc_stage = ifelse(!is.na(sclc_stage) & subgroup == 2, NA, sclc_stage)) %>% mutate(sclc_stage = ifelse(is.na(sclc_stage) & subgroup == 3, 1, sclc_stage))  %>% mutate(sclc_stage = ifelse(is.na(sclc_stage) & subgroup == 4, 2, sclc_stage)) %>% mutate(histology = ifelse(is.na(histology) & (subgroup %in% c(1,2)) , 99, histology)) %>% mutate(histology = ifelse(is.na(histology) & (subgroup %in% c(3,4)) , 1, histology)) %>% filter(!((histology == 1) & (subgroup %in% c(1,2)))) %>% filter(!((histology %in% c(3,4,5,6,7,8,99)) & (subgroup %in% c(3,4)))) %>% filter(eligible!=1|is.na(eligible)) %>% filter(exclude!=2|is.na(exclude)) %>% group_by(subgroup) %>% summarise(freq = n()) %>% mutate(cum = cumsum(freq))
```
```{r}
final <- orDf  %>% mutate(bmi = ifelse(is.na(weight)|is.na(height),NA,weight/((height/100)^2))) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(survdays = ifelse(is.na(survdays), status_dt - regist_dt, survdays)) %>% mutate(subgroup = ifelse(protocol %in% c('S0023', 'S9429','S9712','0117','9410','9801','0214','0324','0617','942452','N0321','N0422','E2597','E3598','9130','S9504','9431','9534','30105','30106','30407','39801','S9019','30605','9734','902451'), 1, NA)) %>% mutate(subgroup = ifelse(protocol %in% c('30203', '30303','30801','952452','E1594','E1599','E4599','N0528','N0821','N9921','S0003','S0339','S0342','S0536','S9308','S9509','S9806','9532','9730','30402','30406','30607','39809','922453','932451','982452','982453','E3503','N0026','S0027','S0126','S0341', '9132','892451','N0022','N0222'), 2, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('9235','9236','30002','30206','39808','892052','952053','0239','E2596','N9923','S0222','S9229','S9713'), 3, subgroup)) %>% mutate(subgroup = ifelse(protocol %in% c('922051','932051','932053','9033','9430','9732','30103','30104','30306','30504','892051','912052','952052','972052','982052','N0027','N0423','N0621','S0119','S0124','S0435','S9705','S9718','S9914','E1500','E3501','E5501','E7593','N0923'), 4, subgroup)) %>% filter(!is.na(subgroup)) %>% filter((stage_initial >= 3 & stage_initial < 99) | (is.na(stage_initial) & !is.na(sclc_stage)) | (protocol %in% c('E1594','E2596','E2597','E3503','E7593','30004' ,'39902' ,'N0423','N0426','N0923','N9921','892051','892052','892451','972051','982453' ))) %>%  filter(!is.na(bmi))%>% filter(!is.na(wgt_losspct))  %>% filter(!is.na(survdays)) %>% filter(bmi<=50) %>% filter(!is.na(age)) %>% filter(!is.na(gender)) %>% filter(ps %in% c(0,1,2)) %>% mutate(race = ifelse(is.na(race),99, race), stage_initial = ifelse(is.na(stage_initial) & subgroup == 1, 3.3, stage_initial)) %>% mutate(stage_initial = ifelse(is.na(stage_initial) & subgroup == 2, 4.1, stage_initial)) %>% mutate(stage_initial = ifelse(!is.na(stage_initial) & subgroup == 3, 1, stage_initial))  %>% mutate(stage_initial = ifelse(!is.na(stage_initial) & subgroup == 4, 2, stage_initial)) %>% mutate(sclc_stage = ifelse(!is.na(sclc_stage) & subgroup == 1, NA, sclc_stage)) %>% mutate(sclc_stage = ifelse(!is.na(sclc_stage) & subgroup == 2, NA, sclc_stage)) %>% mutate(sclc_stage = ifelse(is.na(sclc_stage) & subgroup == 3, 1, sclc_stage))  %>% mutate(sclc_stage = ifelse(is.na(sclc_stage) & subgroup == 4, 2, sclc_stage)) %>% mutate(histology = ifelse(is.na(histology) & (subgroup %in% c(1,2)) , 99, histology)) %>% mutate(histology = ifelse(is.na(histology) & (subgroup %in% c(3,4)) , 1, histology)) %>% filter(!((histology == 1) & (subgroup %in% c(1,2)))) %>% filter(!((histology %in% c(3,4,5,6,7,8,99)) & (subgroup %in% c(3,4)))) %>% filter(eligible!=1|is.na(eligible)) %>% filter(exclude!=2|is.na(exclude)) %>% mutate(time = survdays/(30.4375*12)) %>% mutate(censor = ifelse(status == 2, 1, 0)) %>% mutate(new_censor = ifelse(group == 6 & censor == 0, 1, ifelse(group == 6 & censor == 1, 0, censor))) %>% select(protocol, subgroup, wgt_losspct, race, histology, ps, age, gender, bmi, time, new_censor)
```

```{r}
# save it as csv
write.csv(final, "cleaned_patient_5groups.csv", row.names = FALSE)
```


